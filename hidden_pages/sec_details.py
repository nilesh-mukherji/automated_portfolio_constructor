import streamlit as st
import pandas as pd
import plotly.express as px
from .generate_description import generate_descriptions

import os
# from dotenv import load_dotenv
# load_dotenv(verbose=True)

GENERATE_DATA = os.getenv("GENERATE_DATA") == '1'



st.html("""
    <style>
        .stMainBlockContainer {
            max-width:70rem;
        }
    </style>
    """
)

# Dummy portfolio data
PORT = [{
    'Ticker': 'VOO', 'Category': 'Equity', 
    'Description': "Vanguard's S&P 500 ETF (VOO) offers broad exposure to the U.S. large-cap equity market by tracking the S&P 500 index.  This provides inherent diversification, mitigating company-specific risk.  Holding 500 of the largest U.S. companies across various sectors, VOO's performance is intrinsically linked to the overall health and growth of the American economy. While this broad diversification reduces the impact of any single company's failure, it also means VOO won't significantly outperform a booming specific sector.  Investors should consider their risk tolerance and investment horizon; VOO is generally suitable for long-term investors seeking stable, market-correlated returns, rather than those seeking aggressive growth in specific niche markets.\n\nFrom a security perspective, VOO is considered relatively low-risk compared to individual stocks or sector-specific ETFs.  The S&P 500 is comprised of established, blue-chip companies with proven track records and strong fundamentals.  However, VOO is still subject to market risk, meaning its value can fluctuate based on broader economic factors such as interest rates, inflation, and geopolitical events.  While VOO offers diversification within the large-cap space, it does not provide protection against systemic market downturns.  Investors should be prepared for potential volatility and understand that past performance is not indicative of future results.\n\nVOO’s expense ratio is remarkably low at 0.03%, making it one of the most cost-effective ways to gain exposure to the S&P 500.  This minimal expense ratio translates to significant savings over time compared to higher-cost actively managed funds or ETFs with similar holdings.  Low operating costs contribute directly to an investor's overall returns. This is a critical factor for long-term investors, where even small differences in fees can compound significantly over decades.\n\nLiquidity is another strength of VOO.  As one of the most heavily traded ETFs, VOO boasts high daily trading volume, ensuring investors can easily buy or sell shares at a fair price. This high liquidity minimizes bid-ask spreads and facilitates efficient portfolio management.  Investors can readily adjust their positions without incurring significant trading costs or experiencing delays in execution.  This characteristic is particularly important during periods of market volatility, when the ability to quickly enter or exit a position can be crucial.\n\nWhile VOO offers broad market exposure, it's essential to acknowledge its inherent limitations.  By design, it's tied to the performance of the S&P 500, meaning it won't outperform the index.  Investors seeking to significantly beat the market might consider actively managed funds or specialized ETFs.  Additionally, VOO's focus on large-cap stocks means it underrepresents smaller companies and emerging sectors that could offer higher growth potential, although with increased risk.\n\nAnalyzing VOO in the context of a diversified portfolio is crucial.  While it provides excellent core exposure to U.S. large-cap equities, investors should consider complementing it with other asset classes such as bonds, international stocks, or real estate to further diversify their holdings and manage overall portfolio risk.  The specific allocation to VOO would depend on individual investment goals, risk tolerance, and time horizon.\n\nIn summary, VOO offers a compelling investment opportunity for those seeking broad, low-cost, and liquid access to the U.S. large-cap market.  Its inherent diversification, low expense ratio, and high liquidity are significant advantages.  However, potential investors should be aware of market risks, the limitations of index tracking, and the importance of considering VOO within a broader diversified portfolio strategy tailored to their specific circumstances.\n", 
    'Historical Data': [436.57000732421875, 413.69000244140625, 401.3599853515625, 415.1700134277344, 378.70001220703125, 379.67999267578125, 346.8800048828125, 378.7900085449219, 363.1499938964844, 328.29998779296875, 354.95001220703125, 374.489990234375, 351.3399963378906, 373.44000244140625, 364.1099853515625, 376.07000732421875, 382.04998779296875, 383.8900146484375, 407.2799987792969, 420.67999267578125, 413.8299865722656, 392.70001220703125, 384.1700134277344, 419.3999938964844, 436.79998779296875, 443.82000732421875, 466.92999267578125, 480.70001220703125, 461.42999267578125, 484.6199951171875, 500.1300048828125, 505.92999267578125, 518.0399780273438, 527.6699829101562, 522.6699829101562, 548.778076171875], 
    'Time': ['2021-12-01', '2022-01-01', '2022-02-01', '2022-03-01', '2022-04-01', '2022-05-01', '2022-06-01', '2022-07-01', '2022-08-01', '2022-09-01', '2022-10-01', '2022-11-01', '2022-12-01', '2023-01-01', '2023-02-01', '2023-03-01', '2023-04-01', '2023-05-01', '2023-06-01', '2023-07-01', '2023-08-01', '2023-09-01', '2023-10-01', '2023-11-01', '2023-12-01', '2024-01-01', '2024-02-01', '2024-03-01', '2024-04-01', '2024-05-01', '2024-06-01', '2024-07-01', '2024-08-01', '2024-09-01', '2024-10-01', '2024-11-01']}, 
    
    {'Ticker': 'VUG', 'Category': 'Equity', 'Description': "Vanguard Growth ETF (VUG) tracks the CRSP US Large Cap Growth Index, offering exposure to large-cap U.S. growth stocks.  Analyzing VUG from a security perspective involves understanding not only the inherent risks of equity investments, but also the specific characteristics of growth stocks and the ETF structure itself.  Growth companies, by their nature, reinvest profits to expand operations, often leading to higher volatility compared to value stocks or the broader market.  Their valuations are heavily reliant on future earnings potential, making them sensitive to interest rate changes and shifts in investor sentiment.  A rising interest rate environment can disproportionately impact growth stocks as it discounts the present value of future cash flows.\n\nVUG's concentration in the technology sector presents both opportunities and risks.  While this sector has historically driven market growth, it is also susceptible to rapid technological advancements and disruptions. This concentration amplifies the ETF's sensitivity to sector-specific headwinds like regulatory changes or increased competition.  Further, the large-cap focus, while providing some stability, can mean missing out on potential gains from smaller, faster-growing companies.  Investors should carefully consider their risk tolerance and investment horizon before allocating to VUG.\n\nThe ETF structure itself contributes to VUG's overall risk profile.  While it offers diversification benefits compared to holding individual growth stocks, it is still subject to market risk.  A broad market downturn will negatively impact VUG's performance, albeit potentially to a lesser degree if growth stocks outperform during that period.  Furthermore, while Vanguard has a strong track record, there is a minimal degree of counterparty risk associated with the ETF provider's ability to manage the fund effectively and accurately track the underlying index.\n\nFrom a liquidity perspective, VUG's large asset base and high trading volume generally ensure ease of buying and selling shares.  This minimizes the risk of significant price slippage and allows for efficient portfolio adjustments.  However, during periods of extreme market volatility, even highly liquid ETFs can experience wider bid-ask spreads and temporary price dislocations.  Investors should be aware of this possibility and avoid panic selling during market downturns.\n\nThe expense ratio for VUG is extremely low, which is a significant advantage for long-term investors.  Minimizing fees is crucial for maximizing returns over time, and VUG's low expense ratio allows investors to retain a greater portion of their investment gains.  However, investors should not solely rely on the expense ratio when making investment decisions.  A low-cost ETF that tracks an underperforming index will ultimately yield lower returns than a slightly higher-cost ETF tracking a stronger-performing index.\n\nExamining VUG’s historical performance reveals periods of both significant growth and substantial declines, highlighting the inherent volatility of growth-focused investments.  While past performance is not indicative of future results, it underscores the importance of a long-term investment horizon when considering VUG.  Short-term market fluctuations can significantly impact returns, and investors should be prepared to ride out potential downturns to fully benefit from the long-term growth potential of this asset class.\n\nIn conclusion, VUG offers investors exposure to the potential growth of large-cap U.S. growth stocks, but this comes with inherent risks.  Its concentration in the technology sector, sensitivity to interest rates, and dependence on future earnings projections contribute to its volatility.  However, the ETF structure, high liquidity, and low expense ratio are positive attributes.  Investors should carefully assess their risk tolerance, investment horizon, and overall portfolio diversification before investing in VUG, ensuring it aligns with their individual financial goals and investment strategy.\n", 
    'Historical Data': [320.8999938964844, 290.69000244140625, 277.3599853515625, 287.6000061035156, 250.57000732421875, 243.8300018310547, 222.88999938964844, 251.9600067138672, 239.36000061035156, 213.9499969482422, 222.74000549316406, 233.0399932861328, 213.11000061035156, 235.24000549316406, 231.88999938964844, 249.44000244140625, 252.02999877929688, 265.05999755859375, 282.9599914550781, 292.4599914550781, 289.2799987792969, 272.30999755859375, 267.510009765625, 298.57000732421875, 310.8800048828125, 317.5899963378906, 340.0299987792969, 344.20001220703125, 329.82000732421875, 350.67999267578125, 374.010009765625, 367.29998779296875, 375.54998779296875, 383.92999267578125, 382.9200134277344, 404.0199890136719], 
    'Time': ['2021-12-01', '2022-01-01', '2022-02-01', '2022-03-01', '2022-04-01', '2022-05-01', '2022-06-01', '2022-07-01', '2022-08-01', '2022-09-01', '2022-10-01', '2022-11-01', '2022-12-01', '2023-01-01', '2023-02-01', '2023-03-01', '2023-04-01', '2023-05-01', '2023-06-01', '2023-07-01', '2023-08-01', '2023-09-01', '2023-10-01', '2023-11-01', '2023-12-01', '2024-01-01', '2024-02-01', '2024-03-01', '2024-04-01', '2024-05-01', '2024-06-01', '2024-07-01', '2024-08-01', '2024-09-01', '2024-10-01', '2024-11-01']}, 
    
    {'Ticker': 'QQQ', 'Category': 'Equity', 'Description': "Invesco QQQ Trust (QQQ) tracks the Nasdaq-100 Index, offering exposure to 100 of the largest non-financial companies listed on the Nasdaq Stock Market. This concentration in prominent technology and growth-oriented companies presents both opportunities and risks from a security perspective. While these companies often demonstrate significant growth potential, their performance can be volatile and susceptible to sector-specific headwinds, such as regulatory changes targeting technology or shifts in consumer preferences.  Furthermore, the fund's heavy weighting toward mega-cap tech companies introduces concentration risk; underperformance of a few key holdings can disproportionately impact the overall ETF's returns.\n\nFrom a market risk perspective, QQQ's close correlation with the Nasdaq-100 implies vulnerability to broader market downturns, especially those impacting the technology sector.  Periods of economic uncertainty or rising interest rates can negatively affect growth stocks, potentially leading to significant drawdowns for QQQ.  However, the fund's focus on innovation and disruptive technologies also provides the potential for outsized returns during periods of economic expansion and technological advancement.  Analyzing historical performance data, including maximum drawdowns and recovery periods, is crucial to understanding the potential downside risk and the ETF's resilience during market corrections.\n\nCredit risk is not a direct concern for QQQ as it does not hold debt instruments. However, the underlying companies within the Nasdaq-100 carry their own individual credit risks.  While the index generally comprises large, established companies with strong balance sheets, it's important to be aware that deteriorating financial health within a few heavily weighted companies could indirectly impact QQQ's performance.  Monitoring the financial health and credit ratings of the top holdings within the Nasdaq-100 is, therefore, a relevant consideration for investors.\n\nLiquidity risk is minimal for QQQ given its high trading volume and the underlying liquidity of the constituent stocks.  Investors can typically buy and sell shares of the ETF with ease and minimal slippage.  This high liquidity allows for efficient portfolio management and minimizes the risk of being unable to execute trades at desired prices, especially during periods of market volatility.\n\nOne aspect of operational risk to consider pertains to the ETF's structure and management.  While Invesco is a well-established and reputable asset manager, it's crucial to understand the ETF's expense ratio and any potential tracking error relative to the Nasdaq-100 index.  Tracking error, though typically minimal for well-managed ETFs, represents the difference in performance between the ETF and its underlying index, and can be influenced by factors such as management fees and the efficiency of the replication strategy.\n\nRegarding legal and regulatory risks, investors should be aware of potential regulatory changes impacting the technology sector, such as antitrust investigations or data privacy regulations, which could negatively affect the performance of companies within the Nasdaq-100 and, consequently, QQQ.  Furthermore, changes in tax laws or regulations governing ETFs could also impact investment returns.  Staying informed about the evolving regulatory landscape is essential for managing potential risks associated with investing in QQQ.\n\nIn conclusion, QQQ offers exposure to a dynamic segment of the market with high growth potential but also inherent volatility.  A thorough security analysis requires careful consideration of market risk, concentration risk, and the potential impact of sector-specific regulatory changes. While credit and liquidity risks are relatively low, investors should monitor the financial health of the underlying companies and understand the operational aspects of the ETF.  By carefully weighing the potential risks and rewards, investors can make informed decisions about incorporating QQQ into their investment portfolios.\n", 
    'Historical Data': [397.8500061035156, 363.04998779296875, 346.79998779296875, 362.5400085449219, 313.25, 308.2799987792969, 280.2799987792969, 315.4599914550781, 299.2699890136719, 267.260009765625, 277.95001220703125, 293.3599853515625, 266.2799987792969, 294.6199951171875, 293.55999755859375, 320.92999267578125, 322.55999755859375, 347.989990234375, 369.4200134277344, 383.67999267578125, 377.989990234375, 358.2699890136719, 350.8699951171875, 388.8299865722656, 409.5199890136719, 416.9700012207031, 439.0, 444.010009765625, 424.5899963378906, 450.7099914550781, 479.1099853515625, 471.07000732421875, 476.2699890136719, 488.07000732421875, 483.8500061035156, 505.8598937988281], 
    'Time': ['2021-12-01', '2022-01-01', '2022-02-01', '2022-03-01', '2022-04-01', '2022-05-01', '2022-06-01', '2022-07-01', '2022-08-01', '2022-09-01', '2022-10-01', '2022-11-01', '2022-12-01', '2023-01-01', '2023-02-01', '2023-03-01', '2023-04-01', '2023-05-01', '2023-06-01', '2023-07-01', '2023-08-01', '2023-09-01', '2023-10-01', '2023-11-01', '2023-12-01', '2024-01-01', '2024-02-01', '2024-03-01', '2024-04-01', '2024-05-01', '2024-06-01', '2024-07-01', '2024-08-01', '2024-09-01', '2024-10-01', '2024-11-01']}, 
    
    {'Ticker': 'BND', 'Category': 'Fixed Income', 'Description': "BND, the Vanguard Total Bond Market ETF, offers broad exposure to the U.S. investment-grade bond market. Its portfolio mirrors the Bloomberg U.S. Aggregate Float Adjusted Index, encompassing a wide spectrum of government, corporate, and mortgage-backed securities. This diversified approach mitigates the credit risk associated with individual bond holdings, though it doesn't eliminate it entirely.  While BND holds primarily investment-grade bonds, a portion of its holdings may be subject to downgrades, impacting the fund's overall value.  Furthermore, fluctuations in interest rates pose a significant risk. As interest rates rise, the value of existing bonds decreases, and vice-versa.  This interest rate risk is particularly relevant for BND given its intermediate-term duration, making it moderately sensitive to interest rate changes.\n\nAnalyzing BND's security involves understanding the underlying components of its benchmark index.  Government bonds, constituting a significant portion of the fund, are considered low credit risk due to the backing of the U.S. government. However, they are still susceptible to interest rate risk. Corporate bonds, another substantial component, carry varying degrees of credit risk depending on the issuer's financial health.  BND's diversification across various corporate issuers helps mitigate this risk, but it remains a factor to consider.  Mortgage-backed securities, also present in the fund, are subject to prepayment risk, meaning homeowners can refinance their mortgages when interest rates fall, leading to early principal repayments and potentially lower returns for the fund.\n\nThe fund's expense ratio is remarkably low, a hallmark of Vanguard's passive investment strategy.  This minimizes the drag on returns, allowing investors to retain a greater portion of their investment gains.  Liquidity is another strength of BND, given its large trading volume and the underlying liquidity of the bond market.  This allows investors to easily buy and sell shares without significant price impact.  However,  during periods of market stress, even highly liquid assets can experience reduced liquidity, potentially impacting the ability to trade at desired prices.\n\nFrom an income perspective, BND distributes interest income generated by the underlying bond holdings.  The yield offered by BND fluctuates with prevailing interest rates and the composition of the underlying bond portfolio.  While BND provides a relatively stable income stream, it’s important to note that this income is not guaranteed and can vary.  Investors should consider their individual income needs and risk tolerance when evaluating BND's suitability for their investment objectives.\n\nCompared to other fixed-income investments, BND offers a balanced approach.  Individual bond purchases can provide more tailored exposure to specific maturities and credit qualities, but require significant research and management.  High-yield bond funds offer potentially higher returns but come with significantly greater credit risk.  BND occupies a middle ground, offering diversified exposure to the investment-grade bond market with a relatively moderate level of risk.\n\nFor long-term investors, BND can serve as a stabilizing component within a diversified portfolio.  Its relatively low volatility compared to equities can help cushion portfolio returns during periods of market turbulence.  However, it's crucial to understand that BND is not immune to market fluctuations and can experience losses, especially during periods of rising interest rates.  Furthermore, BND's returns may not keep pace with inflation during periods of low interest rates, potentially eroding purchasing power over time.\n\nIn conclusion, BND presents a relatively low-cost and convenient way to access a diversified portfolio of investment-grade bonds. While it offers advantages in terms of diversification and liquidity, investors should carefully consider the risks associated with interest rate fluctuations, credit downgrades, and prepayment risk before making an investment decision.  Thorough analysis of one’s own investment goals, risk tolerance, and time horizon, coupled with an understanding of BND’s characteristics, are essential for determining its suitability within a broader investment strategy.\n", 
    'Historical Data': [84.75, 83.0, 81.91999816894531, 79.54000091552734, 76.19000244140625, 76.68000030517578, 75.26000213623047, 76.9000015258789, 74.5999984741211, 71.33000183105469, 70.3499984741211, 72.76000213623047, 71.83999633789062, 74.22000122070312, 72.06999969482422, 73.83000183105469, 74.08000183105469, 73.04000091552734, 72.69000244140625, 72.41999816894531, 71.75, 69.77999877929688, 68.52999877929688, 71.43000030517578, 73.55000305175781, 73.43000030517578, 72.22000122070312, 72.62999725341797, 70.66999816894531, 71.63999938964844, 72.05000305175781, 73.5199966430664, 74.36000061035156, 75.11000061035156, 73.05000305175781, 73.2239990234375], 
    'Time': ['2021-12-01', '2022-01-01', '2022-02-01', '2022-03-01', '2022-04-01', '2022-05-01', '2022-06-01', '2022-07-01', '2022-08-01', '2022-09-01', '2022-10-01', '2022-11-01', '2022-12-01', '2023-01-01', '2023-02-01', '2023-03-01', '2023-04-01', '2023-05-01', '2023-06-01', '2023-07-01', '2023-08-01', '2023-09-01', '2023-10-01', '2023-11-01', '2023-12-01', '2024-01-01', '2024-02-01', '2024-03-01', '2024-04-01', '2024-05-01', '2024-06-01', '2024-07-01', '2024-08-01', '2024-09-01', '2024-10-01', '2024-11-01']
    }]

def renderCard(card):
    st.subheader(f"{card['Ticker']} - {card['Category']}")

    # Layout for chart and long description
    col1, col2 = st.columns([4, 6])

    # Chart (40%)
    with col1:
        chart_data = pd.DataFrame({
            "Time": card["Time"],
            "Value": card["Historical Data"]
        })
        fig = px.line(chart_data, x="Time", y="Value", title=f"Historical Performance of {card['Ticker']}")
        st.plotly_chart(fig, use_container_width=True)
        st.write("### Price History")
        st.table(chart_data.loc[::-3].reset_index(drop=True))

    # Long description (60%)
    with col2:
        st.markdown(card["Description"])




# If "Securities Details" is active
def displayDetails(df):
    # Navigation callbacks
    def go_back(length):
        if st.session_state.current_card > 0:
            st.session_state.current_card -= 1
        else:
            st.session_state.current_card = length-1

    def go_next(length):
        if st.session_state.current_card < length - 1:
            st.session_state.current_card += 1
        else:
            st.session_state.current_card = 0

    # Streamlit App
    html_content = '<div style="break-after:page"></div>'
    st.markdown(html_content, unsafe_allow_html=True)
    st.subheader("Securities Analysis")

    if "portfolio" not in st.session_state:
        if GENERATE_DATA:
            with st.spinner("Analyzing your portfolio, stock by stock..."):
                st.session_state.portfolio = generate_descriptions(df)
        else:
            st.session_state.portfolio = PORT

    # Display current card if not in print mode, else show all of them
    if "print_view" not in st.session_state:
        with st.container(height=500, border=False):
            card = st.session_state.portfolio[st.session_state.current_card]
            renderCard(card)
            

            # Navigation buttons
            col1, col2, col3 = st.columns([1, 6, 1])
            with col1:
                st.button("⬅ Back", on_click=lambda: go_back(len(st.session_state.portfolio)))
            
            # with col2:
            #     def reCalc(): del st.session_state.portfolio
            #     st.button("reCalc", on_click=reCalc)

            with col3:
                st.button("Next ➡", on_click=lambda: go_next(len(st.session_state.portfolio)))

            # Card position info
            st.write(f"Card {st.session_state.current_card + 1} of {len(st.session_state.portfolio)}")
    else:
        for i in range(len(st.session_state.portfolio)):
            if i != 0:
                st.markdown(html_content, unsafe_allow_html=True)
            card = st.session_state.portfolio[i]
            renderCard(card)

if __name__ == "__main__":
    displayDetails()
